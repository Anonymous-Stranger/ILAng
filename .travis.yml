language: cpp
os: linux
sudo: required
dist: trusty
compiler:
  - g++
  #- clang++

branches:
  only:
    - master
    - coverity_check
    - coveralls
    - travis

git:
  depth: 1

env:
  global:
  - secure: "jcRxTfzLU+rkktRPkp+IKDuWx/OoSpDqyyQbl+SZNegwFNta7exiMrOCDie33mgKtJXFzqSkbnIy8VSt8Y7Jx0EV3EPHn46amMIquIcvlEAfSjJ6vZ4qgdPz+OI6xiJ1N7ixskQjl1NTWZE0w4HTgUEV9WTuuDWPWHoL2rJWFZNBSBeuyIw1RjrpwzLTL5NEhdNW0+wCmIe1XjhO4O5UAdZR1sEMukxnZ2nhj23K8d6wBBOslJKh/Q2tKLapflaHloXq+ECmIraxe8oVX5T1brAcshfol2awUIcT/VS/2Mf21zPVwBiluzzBhstdh5hUd8up0G7S8o0eUDniihrb9YhxrR9ILHrjLEnZCr77vMqZJiKKfSzFMHVp8Da7hEpgHJND1W4IYzgSnJneC+xMhzd23TX5v8u4DqrZRtrZIoWA7Lic0btXbbZ1VBhYoZrj/ebJFUty6HDUIwlTElXdFdloDzh/l/6zehCLg9tU0oJQfwPQIwulQ9Ciy2UHda4wgWFuQMGqBMVKApCgcHVpAbuPmgNONWuvszRTsT+Qx6xYfMLCizpjMiUmZpkvGtPX5Ed8k2V8m5+G6imAlUCEUm+/RYWvhjEeVFXqQPo6+7VndZUv8SPcqAfhNnkH/JuP+NqQlZH1EGLThl0z7k9GARLgSuGj+59hrFID/WVTySQ="

addons:
  coverity_scan:
    project:
      name: "Bo-Yuan-Huang/ILA-Tools"
      description: "ILA build submitted via Travis CI"
    notification_email: byhuang1992@gmail.com
    build_command_prepend: "mkdir build; cd build; cmake -L -Dcoverage=ON -DZ3_INCLUDE_DIR=/usr/include .."
    build_command: "make"
    branch_pattern: coverity_check

before_install:
  - echo -n | openssl s_client -connect https://scan.coverity.com:443 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' | sudo tee -a /etc/ssl/certs/ca-
  - sudo add-apt-repository --yes ppa:ubuntu-toolchain-r/test
  - sudo apt-get -qq --yes update

install: 
  - gem install coveralls-lcov
  - sudo apt-get install --yes cmake cmake-data
  - sudo apt-get install --yes libboost-all-dev
  - sudo apt-get install --yes lcov

before_script:
  - export PARENT_DIR=$TRAVIS_BUILD_DIR/../
  # z3
  - cd $PARENT_DIR
  - git clone --depth 1 https://github.com/Z3Prover/z3.git
  - cd z3
  - python scripts/mk_make.py
  - cd build
  - make; sudo make install
  # glog
  - cd $PARENT_DIR
  - git clone --depth 1 https://github.com/google/glog.git
  - mkdir -p $PARENT_DIR/glog/build/
  - cd $PARENT_DIR/glog/build/ 
  - cmake ..
  - make && sudo make install
  # coverage test
  - lcov --version
  - gcov --version
  - g++ --version
  # create Makefile
  - mkdir -p $TRAVIS_BUILD_DIR/build && cd $TRAVIS_BUILD_DIR/build
  - lcov --directory $TRAVIS_BUILD_DIR/build --zerocounters

script:
  - cd $TRAVIS_BUILD_DIR/build
  - cmake -L -DZ3_INCLUDE_DIR=/usr/include -Dglog_DIR=$PARENT_DIR/glog/build -Dcoverage=ON -Dpython_api=ON -Ddebug=ON $TRAVIS_BUILD_DIR
  - make

after_success:
  - make run_test
  - lcov --directory $TRAVIS_BUILD_DIR/build --capture --output-file coverage.info 
  - lcov --remove coverage.info 'glog/*' 'test/*' 'app/*' 'cmake/*' '/usr/*' --output-file coverage.info 
  - lcov --list coverage.info 
  - coveralls-lcov coverage.info 

notifications:
    email: false
