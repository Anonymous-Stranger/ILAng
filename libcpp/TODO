TODO
 - rewrite/uniqify ASTs.
   handle commutativity
   probably need hashing

 - must clean up shared_ptr arguments: always pass as const ref.
