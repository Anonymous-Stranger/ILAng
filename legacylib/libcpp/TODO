TODO
 - rewrite/uniqify ASTs.
   handle commutativity
   probably need hashing

 - must clean up shared_ptr arguments: always pass as const ref.
 - write a reorganize function in MemValues which will "compress" the represenation.
